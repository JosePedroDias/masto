<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">

        <title>mastodon</title>

        <style>
            body {
                font-family: sans-serif;
            }

            .toot {
                margin-bottom: 5px;
                padding: 5px;
            }

            .toot:nth-child(odd) {
                background: #CCC;
            }

            .toot .content {
                font-size: 23px;
                line-height: 40px;
            }

            .avatar {
                max-height: 50px;
            }

            .media-image {
                max-height: 400px;
            }

            .read-text {
                display: none;
            }
        </style>
    </head>

    <body>
        _BODY_

        <script>
            function speak(text, lang="en") {
                const utter = new SpeechSynthesisUtterance(text);
                console.log(text, lang);
                utter.lang = lang;
                window.speechSynthesis.speak(utter);

                return new Promise((resolve) => {
                    const timer = setInterval( () => {
                        if (!window.speechSynthesis.speaking) {
                            clearInterval(timer);
                            resolve();
                        }
                    }, 100);
                });
            }

            const chunks = Array.from(document.body.querySelectorAll('.read-text'))
            .map(el => [el.innerHTML, el.getAttribute('lang')]);
            
            chunks.reduce(
                (p, [text, lang]) => p.then(() => speak(text, lang)),
                Promise.resolve()
            );
        </script>
    </body>
</html>
